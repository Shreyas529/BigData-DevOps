pipeline {
    agent any
    
    triggers {
        // Poll SCM every 5 minutes for changes
        // pollSCM('H/5 * * * *')
        // Or use GitHub webhook (recommended)
        githubPush()
    }
    
    environment {
        DOCKER_HUB_CREDENTIALS = 'dockerhub-creds'
        IMAGE_NAME = 'siddharth194/bigdata-devops'
        BACKEND_TAG = 'backend'
        FRONTEND_TAG = 'frontend'
    }
    
    stages {
        stage('Cleanup Previous') {
            steps {
                script {
                    sh '''
                        # Stop compose project and prune test state
                        docker-compose -p test down -v || true

                        echo "Removing old images for ${IMAGE_NAME} (frontend/backend tags)..."

                        # Remove previous frontend images: ${IMAGE_NAME}:frontend-*
                        docker images --format '{{.Repository}}:{{.Tag}} {{.ID}}' \
                          | awk -v repo="${IMAGE_NAME}" -v prefix="${FRONTEND_TAG}-" '$1 ~ (repo ":" prefix) {print $2}' \
                          | xargs -r docker rmi -f || true

                        # Remove previous backend images: ${IMAGE_NAME}:backend-*
                        docker images --format '{{.Repository}}:{{.Tag}} {{.ID}}' \
                          | awk -v repo="${IMAGE_NAME}" -v prefix="${BACKEND_TAG}-" '$1 ~ (repo ":" prefix) {print $2}' \
                          | xargs -r docker rmi -f || true

                        # Cleanup dangling images only (safe for Minikube)
                        docker image prune -f || true
                    '''
                }
            }
        }
        
        stage('Checkout') {
            steps {
                checkout scm
                script {
                    // Print current directory and list files
                    sh '''
                        echo "Current directory: $(pwd)"
                        echo "Files in workspace:"
                        ls -la
                        echo "Files in k8s directory:"
                        ls -la k8s/ || echo "k8s directory not found"
                    '''
                }
            }
        }

        // stage('Run Tests') {
        //     steps {
        //         script {
        //             sh '''
        //                 docker-compose -f docker-compose.test.yml \
        //                     -p test \
        //                     up --build --abort-on-container-exit --exit-code-from test_runner
        //             '''
        //         }
        //     }
        // }

        // stage('Build Images') {
        //     steps {
        //         script {
        //             sh """
        //                 echo "Building Frontend Image..."
        //                 docker build -t ${IMAGE_NAME}:${FRONTEND_TAG}-${BUILD_NUMBER} ./frontend

        //                 echo "Building Backend Image..."
        //                 docker build -t ${IMAGE_NAME}:${BACKEND_TAG}-${BUILD_NUMBER} ./backend
        //             """
        //         }
        //     }
        // }

        // stage('Push to DockerHub') {
        //     steps {
        //         script {
        //             withCredentials([usernamePassword(
        //                 credentialsId: DOCKER_HUB_CREDENTIALS,
        //                 usernameVariable: 'DOCKER_USER',
        //                 passwordVariable: 'DOCKER_PASS'
        //             )]) {
        //                 sh """
        //                     echo \${DOCKER_PASS} | docker login -u \${DOCKER_USER} --password-stdin
                            
        //                     echo "Pushing Frontend Image..."
        //                     docker push ${IMAGE_NAME}:${FRONTEND_TAG}-${BUILD_NUMBER}

        //                     echo "Pushing Backend Image..."
        //                     docker push ${IMAGE_NAME}:${BACKEND_TAG}-${BUILD_NUMBER}

        //                     docker logout
        //                 """
        //             }
        //         }
        //     }
        // }

        stage('Pull Images from DockerHub') {
            steps {
                script {
                    sh """
                        docker pull ${IMAGE_NAME}:${FRONTEND_TAG}-${BUILD_NUMBER}
                        docker pull ${IMAGE_NAME}:${BACKEND_TAG}-${BUILD_NUMBER}
                    """
                }
            }
        }

        stage('Update Kubernetes Manifests') {
            steps {
                script {
                    sh """
                        # Verify we're in the right directory
                        echo "Current working directory: \$(pwd)"
                        echo "Checking for k8s directory..."
                        
                        if [ ! -d "k8s" ]; then
                            echo "ERROR: k8s directory not found!"
                            echo "Contents of current directory:"
                            ls -la
                            exit 1
                        fi
                        
                        # Update image tags in Kubernetes manifests
                        echo "Updating backend-deployment.yaml..."
                        sed -i 's|image: ${IMAGE_NAME}:${BACKEND_TAG}-[0-9]*|image: ${IMAGE_NAME}:${BACKEND_TAG}-${BUILD_NUMBER}|g' k8s/backend-deployment.yaml
                        
                        echo "Updating frontend-deployment.yaml..."
                        sed -i 's|image: ${IMAGE_NAME}:${FRONTEND_TAG}-[0-9]*|image: ${IMAGE_NAME}:${FRONTEND_TAG}-${BUILD_NUMBER}|g' k8s/frontend-deployment.yaml
                        
                        echo "Updating consumer-deployment.yaml..."
                        sed -i 's|image: ${IMAGE_NAME}:${BACKEND_TAG}-[0-9]*|image: ${IMAGE_NAME}:${BACKEND_TAG}-${BUILD_NUMBER}|g' k8s/consumer-deployment.yaml
                        
                        echo "Updating db-init-job.yaml..."
                        sed -i 's|image: ${IMAGE_NAME}:${BACKEND_TAG}-[0-9]*|image: ${IMAGE_NAME}:${BACKEND_TAG}-${BUILD_NUMBER}|g' k8s/db-init-job.yaml
                        
                        echo "Updated manifests with build number: ${BUILD_NUMBER}"
                        
                        # Show what changed
                        echo "=== Verification: Image tags in manifests ==="
                        grep -n "image:" k8s/backend-deployment.yaml k8s/frontend-deployment.yaml k8s/consumer-deployment.yaml k8s/db-init-job.yaml || true
                    """
                }
            }
        }

        stage('Deploy to Minikube via Ansible') {
            steps {
                script {
                    withCredentials([usernamePassword(
                        credentialsId: DOCKER_HUB_CREDENTIALS,
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )]) {
                        sh '''
                            # Check if Ansible is installed
                            if ! command -v ansible-playbook &> /dev/null; then
                                echo "Installing Ansible..."
                                pip3 install ansible
                            fi
                            
                            # Install Kubernetes Ansible collection
                            echo "Installing Kubernetes collection..."
                            ansible-galaxy collection install kubernetes.core --force || true
                            
                            # Install Python Kubernetes client
                            echo "Installing Python Kubernetes client..."
                            pip3 install kubernetes openshift || true

                            echo "========================================"
                            echo " Resetting Minikube cluster"
                            echo "========================================"
                            minikube delete --all --purge || true
                            rm -rf ~/.kube ~/.minikube || true
                            
                            echo "========================================"
                            echo " Starting fresh Minikube"
                            echo "========================================"
                            minikube start \
                              --driver=docker \
                              --memory=8192 \
                              --cpus=4 \
                              --addons=default-storageclass,metrics-server \
                              --kubernetes-version=v1.28.3 || {
                                echo "Failed to start Minikube. Please ensure Minikube is available."
                                minikube status || true
                                exit 1
                              }

                            # Set kubectl context
                            kubectl config use-context minikube || true

                            echo "Waiting for Kubernetes API server to be ready..."
                            READY=0
                            for i in $(seq 1 30); do
                                if kubectl get nodes >/dev/null 2>&1; then
                                    echo "Kubernetes API server is ready."
                                    READY=1
                                    break
                                fi
                                echo "API server not ready yet (attempt $i/30)..."
                                sleep 10
                            done

                            if [ "$READY" -ne 1 ]; then
                              echo "ERROR: Kubernetes API server did not become ready in time."
                              echo "Cluster debug info:"
                              minikube status || true
                              kubectl get pods -A || true
                              exit 1
                            fi

                            echo "Cluster nodes:"
                            kubectl get nodes -o wide

                            # Verify ansible directory exists
                            if [ ! -d "ansible" ]; then
                                echo "ERROR: ansible directory not found!"
                                echo "Current directory: $(pwd)"
                                ls -la
                                exit 1
                            fi
                            
                            # Run Ansible playbook
                            echo "Running Ansible playbook..."
                            cd ansible
                            
                            # Verify playbook exists
                            if [ ! -f "playbook-with-roles.yaml" ]; then
                                echo "ERROR: playbook-with-roles.yaml not found!"
                                ls -la
                                exit 1
                            fi
                            
                            export DOCKER_USERNAME="${DOCKER_USER}"
                            export DOCKER_PASSWORD="${DOCKER_PASS}"
                            export BUILD_NUMBER="${BUILD_NUMBER}"
                            
                            ansible-playbook -i inventory.ini playbook-with-roles.yaml \
                                -e "docker_username=${DOCKER_USER}" \
                                -e "docker_password=${DOCKER_PASS}" \
                                -e "build_number=${BUILD_NUMBER}" \
                                -v
                        '''
                    }
                }
            }
        }

        stage('Verify Deployment') {
            steps {
                script {
                    sh '''
                        echo "========================================"
                        echo "  Verifying Deployment to Minikube"
                        echo "========================================"
                        
                        # Wait for pods to be ready
                        echo ""
                        echo "â³ Waiting for backend pods..."
                        kubectl wait --for=condition=ready pod -l app=backend -n bigdata-devops --timeout=300s || echo "Backend pods not ready yet"
                        
                        echo ""
                        echo "â³ Waiting for frontend pods..."
                        kubectl wait --for=condition=ready pod -l app=frontend -n bigdata-devops --timeout=300s || echo "Frontend pods not ready yet"
                        
                        echo ""
                        echo "========================================"
                        echo "ğŸ“¦ Pods Status"
                        echo "========================================"
                        kubectl get pods -n bigdata-devops -o wide
                        
                        echo ""
                        echo "========================================"
                        echo "ğŸŒ Services Status"
                        echo "========================================"
                        kubectl get svc -n bigdata-devops
                        
                        echo ""
                        echo "========================================"
                        echo "ğŸ“Š HPA Status"
                        echo "========================================"
                        kubectl get hpa -n bigdata-devops || echo "No HPAs found"
                        
                        echo ""
                        echo "========================================"
                        echo "ğŸš€ Deployments Status"
                        echo "========================================"
                        kubectl get deployments -n bigdata-devops
                        
                        echo ""
                        echo "========================================"
                        echo "ğŸ”— Service URLs"
                        echo "========================================"
                        echo "Frontend URL:"
                        minikube service frontend -n bigdata-devops --url || echo "âš ï¸  Frontend service not ready"
                        
                        echo ""
                        echo "Kibana URL:"
                        minikube service kibana -n bigdata-devops --url || echo "âš ï¸  Kibana service not ready"
                        
                        echo ""
                        echo "========================================"
                    '''
                }
            }
        }
    }
    
    post {
        always {
            script {
                sh '''
                    docker-compose -p test down -v || true
                '''
            }
        }
        success {
            echo '================================================'
            echo '  âœ… Pipeline completed successfully!'
            echo '================================================'
            echo "Build Number: ${BUILD_NUMBER}"
            echo 'Images pushed to DockerHub:'
            echo "  - ${IMAGE_NAME}:${BACKEND_TAG}-${BUILD_NUMBER}"
            echo "  - ${IMAGE_NAME}:${FRONTEND_TAG}-${BUILD_NUMBER}"
            echo 'Deployed to Minikube namespace: bigdata-devops'
            echo '================================================'
            
            script {
                sh '''
                    echo ""
                    echo "ğŸŒ Access your application:"
                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    
                    FRONTEND_URL=$(minikube service frontend -n bigdata-devops --url 2>/dev/null || echo 'Not available')
                    KIBANA_URL=$(minikube service kibana -n bigdata-devops --url 2>/dev/null || echo 'Not available')
                    
                    echo "ğŸ“Š Frontend: ${FRONTEND_URL}"
                    echo "ğŸ“ˆ Kibana:   ${KIBANA_URL}"
                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    
                    # Show pod status
                    echo ""
                    echo "ğŸ“¦ Running Pods:"
                    kubectl get pods -n bigdata-devops --no-headers | awk '{print "  - " $1 " (" $3 ")"}'
                ''' 
            }
        }
        failure {
            echo '================================================'
            echo '  âŒ Pipeline failed!'
            echo '================================================'
            echo 'Check the logs above for error details.'
            echo "Build Number: ${BUILD_NUMBER}"
            echo '================================================'
            
            script {
                sh '''
                    echo ""
                    echo "ğŸ” Debugging information:"
                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    
                    echo "Current directory: $(pwd)"
                    echo ""
                    
                    echo "Docker version:"
                    docker --version || echo "Docker not available"
                    echo ""
                    
                    echo "Docker Compose version:"
                    docker-compose --version || echo "Docker Compose not available"
                    echo ""
                    
                    echo "Kubectl version:"
                    kubectl version --client --short || echo "Kubectl not available"
                    echo ""
                    
                    echo "Minikube status:"
                    minikube status || echo "Minikube not available"
                    echo ""
                    
                    echo "Files in workspace:"
                    ls -la
                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                ''' 
            }
        }
    }
}