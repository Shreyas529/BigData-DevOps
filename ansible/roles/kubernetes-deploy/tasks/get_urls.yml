---
- name: Get Frontend Service NodePort
  shell: |
    kubectl get svc frontend -n {{ k8s_namespace }} -o jsonpath='{.spec.ports[0].nodePort}'
  register: frontend_nodeport
  changed_when: false
  failed_when: false

- name: Get Minikube IP
  command: minikube ip
  register: minikube_ip
  changed_when: false
  failed_when: false

- name: Get Kibana Service NodePort
  shell: |
    kubectl get svc kibana -n {{ k8s_namespace }} -o jsonpath='{.spec.ports[0].nodePort}'
  register: kibana_nodeport
  changed_when: false
  failed_when: false

- name: Get Analytics Dashboard Service NodePort
  shell: |
    kubectl get svc analytics-dashboard -n {{ k8s_namespace }} -o jsonpath='{.spec.ports[0].nodePort}'
  register: analytics_nodeport
  changed_when: false
  failed_when: false

- name: Set service URLs
  set_fact:
    frontend_url: "http://{{ minikube_ip.stdout }}:{{ frontend_nodeport.stdout }}"
    kibana_url: "http://{{ minikube_ip.stdout }}:{{ kibana_nodeport.stdout }}"
    analytics_url: "http://{{ minikube_ip.stdout }}:{{ analytics_nodeport.stdout }}"
  when: minikube_ip.stdout is defined and frontend_nodeport.stdout is defined

- name: Display deployment summary
  debug:
    msg:
      - "============================================"
      - "  Deployment Complete!"
      - "============================================"
      - "Frontend URL: {{ frontend_url | default('Not available') }}"
      - "Analytics Dashboard URL: {{ analytics_url | default('Not available') }}"
      - "Kibana URL: {{ kibana_url | default('Not available') }}"
      - ""
      - "Vault (Secrets Management):"
      - "  Internal: http://vault:8200"
      - "  Token: root-token (dev mode)"
      - ""
      - "Alternative access methods:"
      - "  Port-forward: kubectl port-forward -n {{ k8s_namespace }} svc/frontend 8501:8501"
      - "  Port-forward: kubectl port-forward -n {{ k8s_namespace }} svc/analytics-dashboard 5003:5003"
      - "  Port-forward: kubectl port-forward -n {{ k8s_namespace }} svc/kibana 5601:5601"
      - "  Port-forward: kubectl port-forward -n {{ k8s_namespace }} svc/vault 8200:8200"
      - ""
      - "Useful Commands:"
      - "  kubectl get pods -n {{ k8s_namespace }}"
      - "  kubectl get svc -n {{ k8s_namespace }}"
      - "  kubectl get hpa -n {{ k8s_namespace }}"
      - "  kubectl logs -n {{ k8s_namespace }} <pod-name>"
      - "============================================"
