---
- name: Deploy Zookeeper
  kubernetes.core.k8s:
    state: present
    namespace: "{{ k8s_namespace }}"
    definition: "{{ lookup('file', k8s_manifests_dir + '/zookeeper-deployment.yaml') | from_yaml_all }}"

- name: Check Zookeeper pod status
  shell: |
    echo "Checking Zookeeper pods..."
    kubectl get pods -n {{ k8s_namespace }} -l app=zookeeper
    kubectl describe pods -n {{ k8s_namespace }} -l app=zookeeper | tail -20
  register: zookeeper_debug
  changed_when: false

- name: Wait for Zookeeper deployment
  shell: |
    kubectl rollout status deployment/zookeeper -n {{ k8s_namespace }} --timeout=180s
  register: zookeeper_status
  retries: 1
  delay: 5
  until: zookeeper_status.rc == 0
  failed_when: false

- name: Deploy Kafka
  kubernetes.core.k8s:
    state: present
    namespace: "{{ k8s_namespace }}"
    definition: "{{ lookup('file', k8s_manifests_dir + '/kafka-deployment.yaml') | from_yaml_all }}"

- name: Check Kafka pod status
  shell: |
    echo "Checking Kafka pods..."
    kubectl get pods -n {{ k8s_namespace }} -l app=kafka
    kubectl describe pods -n {{ k8s_namespace }} -l app=kafka | tail -30
  register: kafka_debug
  changed_when: false

- name: Wait for Kafka deployment (non-blocking)
  shell: |
    kubectl rollout status deployment/kafka -n {{ k8s_namespace }} --timeout=120s || exit 0
  register: kafka_status
  changed_when: false

- name: Display Kafka status
  debug:
    msg: "Kafka rollout status: {{ kafka_status.stdout }}"
  when: kafka_status.stdout is defined
