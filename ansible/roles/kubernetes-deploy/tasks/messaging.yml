---
# Kafka with KRaft mode - No Zookeeper required!
- name: Deploy Kafka (KRaft mode - no Zookeeper)
  kubernetes.core.k8s:
    state: present
    namespace: "{{ k8s_namespace }}"
    definition: "{{ lookup('file', k8s_manifests_dir + '/kafka-deployment.yaml') | from_yaml_all }}"

- name: Wait for Kafka deployment
  shell: |
    minikube kubectl -- rollout status deployment/kafka -n {{ k8s_namespace }} --timeout=300s
  register: kafka_status
  retries: 3
  delay: 15
  until: kafka_status.rc == 0

- name: Verify Kafka is ready
  shell: |
    minikube kubectl -- wait --for=condition=ready pod -l app=kafka -n {{ k8s_namespace }} --timeout=180s
  register: kafka_ready
  retries: 2
  delay: 10
  until: kafka_ready.rc == 0

- name: Check Kafka pod status
  shell: |
    echo "Checking Kafka pods..."
    minikube kubectl -- get pods -n {{ k8s_namespace }} -l app=kafka
  register: kafka_debug
  changed_when: false

- name: Display Kafka status
  debug:
    msg: "{{ kafka_debug.stdout_lines }}"
