---
- name: Deploy PostgreSQL
  kubernetes.core.k8s:
    state: present
    namespace: "{{ k8s_namespace }}"
    definition: "{{ lookup('file', k8s_manifests_dir + '/postgres-deployment.yaml') | from_yaml_all }}"

- name: Wait for PostgreSQL to be ready
  shell: |
    kubectl wait --for=condition=ready pod -l app=postgres -n {{ k8s_namespace }} --timeout=180s
  register: postgres_ready
  retries: 3
  delay: 10
  until: postgres_ready.rc == 0

- name: Verify PostgreSQL is accepting connections
  shell: |
    kubectl exec -n {{ k8s_namespace }} deploy/postgres -- pg_isready -U postgres -d logindata
  register: pg_isready
  retries: 10
  delay: 5
  until: pg_isready.rc == 0

- name: Delete existing DB Init Job (if any)
  kubernetes.core.k8s:
    state: absent
    api_version: batch/v1
    kind: Job
    namespace: "{{ k8s_namespace }}"
    name: db-init
  ignore_errors: yes

- name: Wait for job pods to be cleaned up
  shell: |
    kubectl delete pods -n {{ k8s_namespace }} -l app=db-init --ignore-not-found=true
  ignore_errors: yes

- name: Run Database Initialization Job
  kubernetes.core.k8s:
    state: present
    namespace: "{{ k8s_namespace }}"
    definition: "{{ lookup('file', k8s_manifests_dir + '/db-init-job.yaml') | from_yaml }}"

- name: Wait for job to be created
  pause:
    seconds: 5

- name: Wait for DB Init Job to complete
  shell: |
    kubectl wait --for=condition=complete job/db-init -n {{ k8s_namespace }} --timeout=300s
  register: db_init_result
  retries: 3
  delay: 15
  until: db_init_result.rc == 0

- name: Check DB Init Job status
  shell: |
    kubectl get jobs db-init -n {{ k8s_namespace }}
  register: job_status
  changed_when: false

- name: Display DB Init Job status
  debug:
    msg: "{{ job_status.stdout_lines }}"
