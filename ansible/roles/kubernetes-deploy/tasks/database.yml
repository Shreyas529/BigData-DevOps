---
- name: Deploy PostgreSQL
  kubernetes.core.k8s:
    state: present
    namespace: "{{ k8s_namespace }}"
    definition: "{{ lookup('file', k8s_manifests_dir + '/postgres-deployment.yaml') | from_yaml_all }}"

- name: Wait for PostgreSQL to be ready
  shell: |
    kubectl wait --for=condition=ready pod -l app=postgres -n {{ k8s_namespace }} --timeout=180s
  register: postgres_ready
  retries: 3
  delay: 10
  until: postgres_ready.rc == 0

- name: Verify PostgreSQL is accepting connections
  shell: |
    kubectl exec -n {{ k8s_namespace }} deploy/postgres -- pg_isready -U postgres -d logindata
  register: pg_isready
  retries: 10
  delay: 5
  until: pg_isready.rc == 0

- name: Delete existing DB Init Job (if any)
  kubernetes.core.k8s:
    state: absent
    api_version: batch/v1
    kind: Job
    namespace: "{{ k8s_namespace }}"
    name: db-init
  ignore_errors: true

- name: Wait for job pods to be cleaned up
  shell: |
    kubectl delete pods -n {{ k8s_namespace }} -l app=db-init --ignore-not-found=true --wait=true
  ignore_errors: true

- name: Pause to ensure cleanup
  pause:
    seconds: 5

- name: Run Database Initialization Job
  kubernetes.core.k8s:
    state: present
    namespace: "{{ k8s_namespace }}"
    definition: "{{ lookup('file', k8s_manifests_dir + '/db-init-job.yaml') | from_yaml }}"

- name: Wait for job pod to be created
  shell: |
    for i in {1..30}; do
      POD=$(kubectl get pods -n {{ k8s_namespace }} -l app=db-init -o jsonpath='{.items[0].metadata.name}' 2>/dev/null)
      if [ ! -z "$POD" ]; then
        echo "Job pod created: $POD"
        exit 0
      fi
      echo "Waiting for job pod... attempt $i/30"
      sleep 2
    done
    exit 1
  register: job_pod_created
  changed_when: false

- name: Wait for DB Init Job to complete
  shell: |
    # First check if job already completed
    COMPLETE=$(kubectl get job db-init -n {{ k8s_namespace }} -o jsonpath='{.status.succeeded}' 2>/dev/null)
    if [ "$COMPLETE" = "1" ]; then
      echo "Job already completed successfully"
      exit 0
    fi
    
    # Check if job failed
    FAILED=$(kubectl get job db-init -n {{ k8s_namespace }} -o jsonpath='{.status.failed}' 2>/dev/null)
    if [ ! -z "$FAILED" ] && [ "$FAILED" -ge "1" ]; then
      echo "Job failed!"
      kubectl logs -n {{ k8s_namespace }} -l app=db-init --tail=50
      exit 1
    fi
    
    # Wait for job to complete
    kubectl wait --for=condition=complete job/db-init -n {{ k8s_namespace }} --timeout=300s
  register: db_init_result
  retries: 3
  delay: 15
  until: db_init_result.rc == 0

- name: Show DB Init Job logs
  shell: |
    kubectl logs -n {{ k8s_namespace }} -l app=db-init --tail=20
  register: job_logs
  changed_when: false
  ignore_errors: true

- name: Display DB Init Job logs
  debug:
    msg: "{{ job_logs.stdout_lines }}"
  when: job_logs.stdout_lines is defined

- name: Check DB Init Job status
  shell: |
    kubectl get jobs db-init -n {{ k8s_namespace }}
  register: job_status
  changed_when: false

- name: Display DB Init Job status
  debug:
    msg: "{{ job_status.stdout_lines }}"