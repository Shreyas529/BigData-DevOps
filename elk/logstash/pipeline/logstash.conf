input {
  # Receive logs on port 5044 via TCP
  tcp {
    port => 5044
    codec => json
  }
  
  # Also accept UDP (optional)
  udp {
    port => 5044
    codec => json
  }
}

filter {
  # Parse the timestamp from your logs
  if [timestamp] {
    date {
      match => [ "timestamp", "ISO8601" ]
      target => "@timestamp"
    }
  }
  
  # Add tags for backend service
  if [service] == "backend" {
    mutate {
      add_tag => [ "backend", "flask" ]
    }
  }
  
  # Add tags for consumer service
  if [service] == "consumer" {
    mutate {
      add_tag => [ "consumer", "kafka-consumer" ]
    }
  }
  
  # Extract login event fields for better searching
  if [event_type] == "login_event" {
    if [event_data][user_id] {
      mutate {
        add_field => { "login_user_id" => "%{[event_data][user_id]}" }
      }
    }
    if [event_data][country] {
      mutate {
        add_field => { "login_country" => "%{[event_data][country]}" }
      }
    }
    if [event_data][device] {
      mutate {
        add_field => { "login_device" => "%{[event_data][device]}" }
      }
    }
    if [event_data][status] {
      mutate {
        add_field => { "login_status" => "%{[event_data][status]}" }
      }
    }
  }
}

output {
  # Send to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "netflix-logs-%{+YYYY.MM.dd}"
  }
  
  # Also print to console (for debugging)
  stdout {
    codec => rubydebug
  }
}